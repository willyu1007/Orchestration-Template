# 智能体编排图结构描述

## 1. 基本范式
- 图类型：有向多重图（Directed Multigraph）。允许多条边、条件分支与回边，默认鼓励 DAG。
- 节点（Agent）：能力与接口的载体。
- 端口（Ports）：输入/输出的类型和契约。
- 边（Edges）：连接端口的通道，承载条件、变换等运行语义。
- 执行语义：调度策略、一致性与失败处理。

## 2. 节点描述
```yaml
id: string
kind: router|planner|tool|llm|service|memory|evaluator|human_in_loop
entrypoint:
  type: http|grpc|local|fn|queue
  uri: string
capabilities:
  - extract_entities
  - web_search
inputs:
  - port: in
    schema_ref: #/schemas/Query
outputs:
  - port: out
    schema_ref: #/schemas/Plan
constraints:
  max_latency_ms: 1500
  cost_budget: 0.005
policy:
  retry: {max_attempts: 2, backoff: exp, base_ms: 200}
  timeout_ms: 1400
observability:
  emit: [metrics, logs, traces, events]
stateful: false
version: "2025-11-12"
```

## 3. 边描述
```yaml
from: <node_id>:<out_port>
to: <node_id>:<in_port>
condition:
  expr: "out.intent in ['search','plan'] && out.confidence > 0.7"
transform:
  script_ref: "#/transforms/plan_compact"
qos:
  priority: 5
error_route:
  to: evaluator:in
  on: [Timeout, RetryExhausted]
```

## 4. 图级元数据
```yaml
graph:
  id: "agent-orchestrator"
  version: "1.3.0"
  mode: dag|state_machine|petri_net
  entry_nodes: [ingress]
  terminal_nodes: [finalizer]
  scheduler:
    strategy: parallel_if_independent
    max_concurrency: 8
  security:
    authn: oauth2|mtls|none
    authz: abac|rbac
  audit: enabled
```

## 5. 示例
```yaml
schemas:
  Query: {type: object, required: [text], properties: {text: {type: string}}}
  Plan:  {type: object, properties: {steps: {type: array, items: {type: string}}, intent: {type: string}, confidence: {type: number}}}
  Result:{type: object, properties: {answer: {type: string}, citations: {type: array, items: {type: string}}}}

nodes:
  - id: ingress
    kind: router
    entrypoint: {type: fn, uri: ingress_route}
    inputs:  [{port: in,  schema_ref: "#/schemas/Query"}]
    outputs: [{port: out, schema_ref: "#/schemas/Query"}]

  - id: planner
    kind: llm
    entrypoint: {type: http, uri: http://llm/planner}
    capabilities: [plan, intent_detect]
    inputs:  [{port: in,  schema_ref: "#/schemas/Query"}]
    outputs: [{port: plan, schema_ref: "#/schemas/Plan"}]
    policy: {retry: {max_attempts: 1}, timeout_ms: 12000}

  - id: web_tool
    kind: tool
    entrypoint: {type: http, uri: http://tools/web_search}
    capabilities: [web_search]
    inputs:  [{port: in, schema_ref: "#/schemas/Plan"}]
    outputs: [{port: out, schema_ref: "#/schemas/Result"}]

  - id: finalizer
    kind: service
    entrypoint: {type: fn, uri: format_answer}
    inputs:  [{port: in, schema_ref: "#/schemas/Result"}]
    outputs: [{port: out, schema_ref: "#/schemas/Result"}]

edges:
  - from: ingress:out
    to: planner:in
  - from: planner:plan
    to: web_tool:in
    condition: {expr: "out.intent == 'search' && out.confidence >= 0.6"}
  - from: web_tool:out
    to: finalizer:in

graph:
  id: "qa-orchestration"
  version: "0.1.0"
  mode: dag
  entry_nodes: [ingress]
  terminal_nodes: [finalizer]
  scheduler: {strategy: parallel_if_independent, max_concurrency: 4}
```

## 6. JSON Schema
```json
{
  "$id": "https://example.com/agent-graph.schema.json",
  "type": "object",
  "required": ["nodes", "edges", "graph"],
  "properties": {
    "nodes": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "kind", "inputs", "outputs"]
      }
    },
    "edges": {"type": "array"},
    "graph": {"type": "object"}
  }
}
```

## 7. 关键设计点
- 数据契约优先
- 非功能性指标下沉
- 并发与幂等
- 可观测优先
- 治理与灰度
- 安全与合规

## 8. 扩展方向
- 状态机模式
- Petri 网
- BPMN 对接
