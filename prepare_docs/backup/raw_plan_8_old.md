# 阶段八：能力与知识补全、文档层完善与质量体系建设规划

> 目标（一句话）：在前七阶段完成架构与运行时建设的基础上，**补齐模板内“基础设施能力族”和关键知识文档，搭建清晰的人类说明层，并通过系统测试与 CI 把模板打磨到可复用、可信赖的工程资产水平**；斜杠命令等体验优化为可选增强项。

---

## 1. 阶段定位与总体目标

### 1.1 在整体路线中的位置回顾

- **阶段 1–3**：搭建目录骨架、文档规范与核心机制说明（模块 / 能力 / 路由 / Hook）；  
- **阶段 4–5**：实现注册写入脚本与脚手架（Scaffolding），让“新增模块 / 能力 / Route / Hook”有标准流程；  
- **阶段 6**：用真实的小规模样本注册知识 / 能力 / Hook，验证脚手架工作；  
- **阶段 7**：实现 Ability Runtime + Hook Runtime + 最小 Agent Runtime，使架构文档中“执行”和“联动”具备可运行实现。  

**阶段八**不再扩展新机制，而是三件事：

1. **补内容**：补齐一组“基础设施能力族”和与模板强相关的知识文档；  
2. **建说明层**：构建面向人类的 README / Handbook / 工具路由，让人可以快速理解模板整体情况与用法；  
3. **建质量线**：用单测、契约测试、集成测试 + CI，把模板打磨到“可以放心复用”的稳定水平；示例（examples）来自这些测试过程中的正反面案例。  

斜杠命令（如用于触发注册/脚手架的 `/.scaffold` 类命令）属于**可选增强**，在有余力时添加。

### 1.2 范围边界（做什么 / 不做什么）

**本阶段重点：**

- 只补充**基础设施能力族**（infra-oriented abilities），不扩展具体业务领域能力；  
- 文档层重点是：**让人清晰理解架构与用法**，而不是详细重复 knowledge 下所有内容；  
- 测试不只验证“能跑”，还要为“后续大量项目基于模板生成”打下可靠性基础；  
- CI 流程纳入本阶段范围，成为质量线的一部分。  

**本阶段不做：**

- 不引入新的运行时机制 / 路由模型；  
- 不追求覆盖所有潜在能力，只构建一组“高复用的 infra 能力族”；  
- 不构建复杂 UI，只围绕 CLI + 文档层优化体验。  

---

## 2. 工作块 A：基础设施能力族与知识补全

### 2.1 工作块目标

> **为模板补齐一组与 repo 特性紧密相关的“基础设施能力族”与配套知识，使后续任何基于模板生成的项目，都能直接复用这些能力完成自检、自修与日常维护。**

这里的“能力”限定为 infra 级别，服务于：

- 模板结构健康检查；  
- registry/config/hooks/AGENTS 等元数据的一致性维护；  
- 运行时自检；  
- 测试与 CI 的辅助；  
- 文档/索引的自动更新等。  

### 2.2 能力族范围（示例）

1. **模板健康检查能力**  
   - 检查模块目录与 `modules/overview/*.yaml` 是否一致；  
   - 检查 registry/config/hooks 中是否存在 dangling 引用；  
   - 校验 AGENTS 中引用的 knowledge 文档是否存在。  

2. **结构 / 文档同步能力**  
   - 根据 registry / MANIFEST 变化，自动更新：  
     - 模块内 `AGENTS.md` 的能力列表片段；  
     - 工具索引文档中某些列表段落；  
   - 保证“代码 / 元数据 / 人类文档”三者尽量同步。  

3. **运行时自检能力**  
   - 检测 Ability Runtime / Hook Runtime 的基本可用性：  
     - config 能否定位到脚本实现；  
     - hook handler 是否可执行；  
     - 在不触发真实业务副作用的前提下跑一轮 smoke test。  

4. **测试与 CI 辅助能力**  
   - 一键运行“模板测试套件”（见工作块 C）；  
   - 收集最近一次测试执行结果，生成简要报告，帮助人快速定位问题。  

### 2.3 实施方式与约束

- 所有能力均通过**既有的能力生命周期与脚手架**落地：  
  - 使用 Phase 5 的脚手架（new_ability_low/high）新增能力；  
  - 使用 Phase 4/6 的 registry/config 写入脚本完成注册；  
  - 确保 Ability Runtime（Phase 7）可以执行。  

- 每个能力必须：  
  - 在 `.system/registry/low-level|high-level` 注册；  
  - 在 `.system/registry/config/abilities.yaml` 有执行配置；  
  - 经过了至少一个相关测试用例（单测或集成测试）。  

- 所有能力均为**模板 infra 能力**，不引入具体业务逻辑。  

---

## 3. 工作块 B：面向人类的整体说明层（README / Handbook / 工具路由）

### 3.1 工作块目标

> **为人类提供一层清晰、简明的说明层，使其在不深入阅读所有知识文档的情况下，仍能掌握模板的整体结构、理念与主要使用方式，并能对齐设计思路与需求。**

这一层主要解决：

- “这是个什么模板？”  
- “目录这么多，哪一块负责什么？”  
- “如果我要做 X，要从哪里看/怎么开始？”  

### 3.2 核心文档与职责分工

为避免重复维护，文档层采用“**少量入口 + 摘要 + 路由**”的策略：

1. **根级 `README.md` —— 入门总览**  
   - 职责：新读者的**第一眼**；  
   - 内容重点：  
     - 模板目标与典型使用场景；  
     - 顶层目录结构简要说明（modules / .system / knowledge / PROJECT_INIT / ops …）；  
     - “如果你是：”  
       - 人类开发者：应先读哪些 AGENTS / Handbook / TOOLS 文档；  
       - 外部 AI：应遵守哪些 AGENTS 规则 / 使用哪些脚本入口；  
     - Quick Start：  
       - **最少步骤跑一次模板自检 & 测试**；  
       - 示例斜杠命令 / CLI 调用（若实现）。  

2. **Template Handbook（放在项目初始化目录下）**  
   - 职责：对模板的**体系化讲解**；  
   - 内容重点：  
     - 核心目录与组件职责详细说明；  
     - 模块 / 能力 / 路由 / Hook / Runtime / Scaffolding 的整体关系图；  
     - 若干典型工作流：  
       - 初始化项目；  
       - 新增模块；  
       - 新增能力 / Hook；  
       - 跑 DevOps 脚手架；  
     - 指向 knowledge 下的详细技术文档。  

3. **Tools & Abilities Overview（如 `TOOLS_OVERVIEW.md`）**  
   - 职责：为人类提供“工具地图”；  
   - 内容重点：  
     - 按类别列出常用基础设施能力与脚本工具；  
     - ability_id / 脚本入口 / 适用场景；  
     - 与哪份知识文档关联（ability_routing / config / examples 等）。  

4. **Tools Routing（如 `TOOLS_ROUTING.md`，可与上文合并）**  
   - 职责：从“**人类任务**”到“**具体工具/脚手架**”的映射；  
   - 示例：  
     - “我要新增一个模块” → 查看某些文档 → 调用某脚手架命令；  
     - “我要检查模板结构是否健康” → 调用某能力；  
     - “我要为能力加 Hook 保护” → 查看 Hook 文档 + 脚手架。  

5. **Runtime & Hooks Overview（可为独立文档或 Handbook 章节）**  
   - 职责：用人话解释运行时与 Hook 的协作关系；  
   - 内容：  
     - Ability Runtime / Hook Runtime / Agent Runtime 之间的数据流；  
     - Hook 对 AI 行为的影响边界；  
     - 外部 AI 如何通过命令行接口与 runtime 协作。  

### 3.3 避免重复的维护策略

- 详细技术规范仍集中在 `knowledge/` 下；  
- README / Handbook / TOOLS 层只做“摘要 + 链接路由”；  
- 在 `DOCS_CONVENTION.md` 中明确：  
  - 更新流程为“先改 knowledge 源文档，再由 AI 负责刷新摘要层文档”，人类只做审核。  

---

## 4. 工作块 C：测试体系与 CI（质量线建设）

### 4.1 工作块目标

> **为模板建立一套可靠的测试与 CI 体系，确保模板本身“没有明显 bug / 配置错误”，能够安全作为后续多个项目的起点；并为后续性能/可靠性优化与高级特性打下基础。**

### 4.2 测试维度与内容

1. **单元测试（Unit Tests）**  
   - 覆盖对象：  
     - Registry 写入脚本（Phase 4）；  
     - Ability Runtime（ability_runner / ability_lib）；  
     - Hook Runtime（hook_runner）；  
     - 核心基础设施能力脚本（工作块 A 中实现的能力）。  
   - 目标：  
     - 验证各模块在“理想输入 + 常见错误输入”下行为合理。  

2. **契约测试（Contract / Schema Tests）**  
   - 覆盖对象：  
     - registry / config / hooks 的 schema 与 cross-reference；  
     - AGENTS 中的关键引用（例如指向 knowledge 文档路径）。  
   - 目标：  
     - 确保仓库中所有 YAML / 配置在结构上合法；  
     - 不存在明显的 dangling 引用或关键漏项。  

3. **集成测试（Integration Tests）**  
   - 示例场景：  
     - “新增能力 → 注册 → Runtime 调用 → Hook 触发 → 记录”的完整链路；  
     - “新增 Hook → guard/telemetry 生效”的链路；  
     - “脚手架新增模块 → registry / 目录 / AGENTS 一致”的链路。  
   - 目标：  
     - 验证前七阶段搭建的各层协同正常工作。  

4. **稳定性 / 性能基本线（轻量）**  
   - 适度测试例如：  
     - 多次并发调用简单能力，观察是否有资源泄漏或明显性能退化；  
     - 批量运行 registry/config 校验，确保在合理时间内完成。  
   - 重点不是极致优化，而是避免明显性能坑和不稳定点。  

### 4.3 CI 集成

将测试流程纳入模板自身的 CI（例如 GitHub Actions / GitLab CI 等），包括：

- 安装依赖；  
- 运行单元测试；  
- 运行契约 / schema 测试；  
- 运行关键集成测试；  
- 在 README / Handbook 中说明 CI 状态与如何在本地重现。  

**完成标准（测试与 CI 块）：**

- 模板仓库本身有一套可运行的 CI 配置；  
- 所有核心测试在 CI 中通过；  
- 新项目基于模板生成时，可以继承这套 CI 配置作为默认质量线。  

---

## 5. 工作块 D：Examples 作为“经验知识”的沉淀

### 5.1 工作块目标

> **将测试与实战过程中遇到的典型情况（包括成功案例和失败/坑案例）沉淀为知识文档，帮助未来的使用者理解“如何正确使用模板”以及“常见陷阱”。**

### 5.2 形式与落点

- 在 `knowledge/examples/` 下建立案例文档，例如：  
  - `example_add_ability_success.md`：记录一次顺利新增能力的流程与关键设计点；  
  - `example_hook_guard_pitfall.md`：记录某次 Hook 配置错误导致问题的案例，以及后续修复方案；  
  - `example_scaffolding_misuse.md`：记录脚手架误用场景与正确用法对比。  

- 每个案例文档包括：  
  - 背景（需求 / 场景）；  
  - 操作步骤（可引用对应 tests / workdocs）；  
  - 正面/负面结果；  
  - 教训与推荐实践；  
  - 相关的能力 / Hook / 脚手架 / 测试链接。  

### 5.3 与测试的关系

- 每一个 integration / scenario 测试都可以对应一个 example 文档；  
- 当测试发现 bug 并修复后，应同步补充一个“负例 -> 正例”的 case，帮助未来使用者避免重蹈覆辙。  

**完成标准（Examples 块）：**

- 存在若干具有代表性的正/反例案例文档；  
- 案例与测试/脚手架/能力之间有互相引用，构成“经验网络”。  

---

## 6. 工作块 E：斜杠命令与体验优化（可选增强）

### 6.1 工作块目标

> **在不影响核心设计的情况下，为常用操作提供便捷入口（斜杠命令 / Make 目标 / CLI 别名），降低人类与外部 AI 的使用门槛。**

注意：本块为**非必选**，优先级低于 A–D。当资源不足时可以整体推迟。

### 6.2 建议的最小集合（若实施）

1. **推荐斜杠命令集合（约定层）**  
   - `/.scaffold module` —— 建议执行“新增模块”脚手架；  
   - `/.scaffold ability` —— 新增 infra 能力（AI 再问 low/high 等细节）；  
   - `/.scaffold hook` —— 新增 Hook 注册；  
   - `/.run ability <id>` —— 通过 Ability Runtime 执行能力；  
   - `/.inspect registry` —— 调用 introspection 能力查看当前 registries 状态。  

   这些可以先作为**对话中的约定表达**写进 AGENTS.md，即便暂时没有完全对应的 CLI。

2. **可执行 CLI / Make 目标（实现层，若有）**  
   - 在 `scripts/cli/` 或根 `Makefile` 中为上述操作提供 wrapper：  
     - 如 `make scaffold-module` → 调用 `scripts/scaffold/new_module.py`；  
     - 如 `make run-ability ABILITY_ID` → 调用 `ability_runner`。  

3. **文档说明**  
   - 在根 README / Tools Routing 文档中标出这些斜杠命令 / make 目标；  
   - 说明这些命令是“推荐用法”，但不是使用模板的前置条件。  

**完成标准（体验块）：**

- 若有实施：常用操作有清晰的快捷命令，并在文档中说明；  
- 若未实施：仍有一份“推荐斜杠命名规范”记录在 AGENTS / 文档中，为后续增强预留空间。  

---


## 7. 阶段八完成判定标准（Definition of Done）

当满足以下条件时，可认为 Phase 8 已完成：

1. **基础设施能力族已补齐**  
   - 至少一组与模板强相关的能力（健康检查 / 结构同步 / 运行时自检 / 测试辅助等）被完整实现并注册；  
   - 这些能力可通过 Ability Runtime 调用，并在相关模块的 ABILITY 文档中有说明；  
   - 相关能力有对应测试覆盖。  

2. **面向人类的说明层清晰易用**  
   - 根级 README、Template Handbook、Tools Overview / Routing 等文档存在且结构合理；  
   - 新人只通过这些文档即可理解模板整体情况和主要用法。  

3. **测试与 CI 构成可复用的质量线**  
   - 模板仓库具备完善的单测 / 契约测试 / 针对关键路径的集成测试；  
   - CI 流程集成这些测试并稳定通过；  
   - 模板被设计为后续项目可直接继承这套 CI 作为默认质量线。  

4. **Examples 形成经验知识库**  
   - 测试与实战过程中的若干正/反例已沉淀为 `knowledge/examples` 下的案例文档；  
   - 每个例子都能关联到对应测试 / 能力 / Hook / 脚手架，帮助使用者避免常见坑。  

5. **斜杠命令（若实施）有合理说明**  
   - 若实现：常用操作有清晰的 CLI/斜杠命令封装，并在 README / AGENTS 中说明；  
   - 若暂未实现：仍有一套推荐命令/约定在文档中记录，留待后续增强。  

达到以上标准后，repo 模板即进入“稳定可复用”的状态，后续迭代可以围绕具体项目需求，按需扩展能力、适配业务领域，并在不破坏模板质量线的前提下引入更多高级特性（异步 Hook、复杂 DevOps 集成等）。
