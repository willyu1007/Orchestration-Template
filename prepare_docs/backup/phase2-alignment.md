# 阶段2对齐文档（草案 v0.1）
日期：2025-11-19

> 目的：聚焦**规范与思想**，基于《discussion.md》与阶段1产出，沉淀双方共识、差异、待确认事项，并列出推进 repo 模板所需的**关键决策**与**下一步**。

---

## TL;DR（一页版）
- **定位**：本模板不是功能集合，而是一套“让 AI 高效+可控开发”的**规范与编排底座**。
- **入口**：根目录 `AGENTS.md`（必读策略） + 根 `ROUTING.md`（最小路由树）；其余按“渐进式”在需要时加载。
- **文档分层**：① 规范文档（Rules）② 格式规范（Schemas & Examples）③ 人类阅读文档（Human Docs，AI 禁读）。
- **功能编排**：能力注册与功能体注册分离；功能体路由仅暴露“可被编排的功能体/Agent”，基础能力进入能力注册表。
- **跨模块**：用“**编排任务** + **模块子任务**”的拆分原则；一个执行单元只触达一个模块目录，跨模块由 Orchestrator 串联。
- **初始化**：项目/模块两条脚手架；新增/变更明确影响的**体系与清单**；以“只注册+就绪文档”为终点（不捆绑开发实现）。
- **触发与护栏**：Triggers 可演化，提供生成/检查器与冲突检测；Guardrail 以策略+校验脚本强约束。
- **推进**：本轮需拍板 9 个决策（见下文），拍板后进入阶段3生成“可执行建设计划”。

---

## 1. 已达成共识
1) **关注点**：强调规范化管理与建设思路优先于功能描述；Quickstart 不是固定路径/命名，**叶子文档要承上启下**（承接 ROUTING、向下拆解渐进链）。  
2) **命名与文档角色**：三大体系（文档路由 / 能力路由 / AI 友好）相关文档**必须**命名一致、角色明确；人类文档除 README 无强约束，但**需显式标注 AI 禁读**。  
3) **复杂度控制**：引导文档仅作**方法论参考**；真正的模板以“底层能力→功能体→编排链”为先，避免空转。项目初始化 ≠ 模块初始化。  
4) **文档分类**：采用“三类文档”：**规范文档**、**格式规范**、**人类阅读文档**；示例按**渐进原则**组织，避免一次性灌入。  
5) **模块脚手架**：通过交互式脚手架**收集信息→生成实例**；新增模块**必须**纳入路由/注册/编排三套体系。  
6) **能力与功能体**：**双注册**（capability / agent），但**编排只面向功能体**；基础能力为功能体的构件。  
7) **触发/护栏演进**：随项目发展动态更新，要求有**生成与校验工具**避免冲突/滥用。  
8) **验收与计划**：需要**建设计划概览**与**可验证的验收标准**，确保四个建设思路落地且可维护。

---

## 2. 潜在分歧 / 需要统一的理解
- **功能体路由的“粒度”**：是否把**基础能力**也暴露到功能体路由？（我方建议：**不暴露**，仅在能力注册表；路由只暴露可被直接编排的功能体/Agent）  
- **模块是否作为编排节点**：模块间关系如何表达？是否使用 subroute？（我方建议：**模块不直接互调**；跨模块由 Orchestrator 基于任务图编排，关系在“模块关系/依赖清单”维护）  
- **何时进入功能体路由**：缺少“晋级标准”（实验→候选→稳定）。（我方建议：以**规范齐备+接口稳定+用例覆盖**为晋级门槛）  
- **Quickstart 的定位**：不是固定的文件/位置，而是**一类叶子角色**（承接/分流）。需要在命名与 front-matter 上达成统一标识。  
- **触发器规模与冲突**：需定义“**命名空间、优先级、互斥规则**”与“冲突检测/干跑（dry-run）”。  
- **初始化“是否同时实现功能”**：倾向**仅注册与文档就绪**，不强制实现具体功能（避免把“模板建设”与“业务实现”耦合）。

---

## 3. 待明确事项（Blocking）
1) **AI 必读清单**：根入口最小集合 = `AGENTS.md` + `ROUTING.md` + （可选）`READ_FIRST.md`？是否需要统一 front-matter 标识 `required: true`。  
2) **文档角色标注**：规范文档/格式规范/人类文档的**front-matter 标准**与**统一标签**（如 `audience: ai|human`、`doc_kind:`、`route_role:`）。  
3) **能力/功能体命名规范**：是否采用前缀方案：`base.<domain>.<action>`、`agent.<domain>.<role>`、`flow.<domain>.<intent>`。  
4) **功能体晋级门槛**：三段式生命周期与对应**CI Gate**（实验/候选/稳定各自需要的文档、测试、使用记录）。  
5) **跨模块编排边界**：是否强制“一个执行单元只触达一个模块目录”？跨模块一律拆成**父任务 + 子任务**。  
6) **触发器规范**：命名空间、优先级、互斥/并行规则、冲突检测、回退策略、审计字段（谁触发/为何阻断）。  
7) **脚手架输出**：新增模块/项目分别**影响哪些注册与文档**（精确到文件/字段）；需提供**机器可校验**的完成清单。  
8) **验收标准**：四大思路的**可操作验收项**与**度量**（如：路由可达率、文档-功能一致性、触发冲突率、恢复速度等）。  
9) **人类文档索引**：是否提供一个 `HUMANS.md` 作为人类入口索引（并在开头声明 AI 禁读）。

---

## 4. 关键决策节点（选项-分析-建议）

### D1. 功能体路由是否包含“基础能力”节点？
- **A. 包含**：可见性好；但路由噪声大，编排面增厚，易与能力注册重复。
- **B. 不包含**（**建议**）：编排只面向“可独立执行/被调度”的功能体；基础能力留在 `capabilities.yaml` 与 `CAPABILITIES.md`，由功能体引用。  
- **配套**：在功能体描述中显式列出“依赖的基础能力清单”，CI 校验依赖存在。

### D2. 模块是否作为编排节点？
- **A. 允许模块间直接互调**：灵活但复杂，风险大（循环依赖/不可追踪副作用）。
- **B. 统一经 Orchestrator 编排**（**建议**）：**一个执行单元只触达一个模块目录**；跨模块通过任务图拆分为子任务，由 Orchestrator 串联，依赖关系写入“模块依赖/关系图”。

### D3. 功能体进入路由的“晋级标准”？
- **A. 只要存在就登记**：快，但不稳定，文档与实现易漂移。  
- **B. 三段式**（**建议**）：**实验→候选→稳定**；进入路由从“候选”开始。门槛：规范/接口固定、最小用例通过、触发/护栏已配置；CI Gate 强约束。

### D4. 触发器治理
- 规范：`trigger_id` 命名空间（domain.scope.action）、优先级（P0/P1…）、互斥组、`enforcement`（observe/warn/block）、`preload_docs`、`required_checks`。  
- 工具：**生成器**（从模板生成/升级）、**干跑**（全量模拟）、**冲突检测**（互斥/循环/优先级）、**度量**（命中频率/平均阻断时长）。  
- **建议**：将触发器视为“**配置即代码**”，纳入评审与回归套件。

### D5. Quickstart 的统一标识
- **建议**：把“承上启下的叶子”统一标注为 `route_role: quickstart`；命名不强制，但 front-matter 必含 `route_role: quickstart` 与 `handoff:` 指向下一跳。

### D6. 初始化的终点定义
- **建议**：**“只注册+就绪文档”即完成**。即：目录/注册/路由/策略/触发/占位用例齐备；**不强制**交付任何业务功能代码。

### D7. 能力/功能体命名规范
- **建议**：采用三前缀：`base.<domain>.<action>` / `agent.<domain>.<role>` / `flow.<domain>.<intent>`，并由 lint 校验唯一性与引用完整性。

### D8. 人类/AI 文档分流
- **建议**：在所有人类文档 front-matter 写 `audience: human` + `ai_read: false`，并在根 README 提供 `HUMANS.md` 索引；AI 入口只通过 `AGENTS.md`/`ROUTING.md`。

### D9. 跨模块任务的提交策略
- **建议**：一组跨模块改动 = **父 Issue/PR + 子 PR（每模块一个）**；CI 绑定“跨模块改动守则”，禁止单 PR 同时修改多个模块目录。

---

## 5. 文档分类与入口（建议落地稿）
**入口（AI 必读）**  
- `AGENTS.md`（根）：角色/边界/护栏总则 + 三大体系入口。  
- `ROUTING.md`（根）：`scope/topic/when` 的最小路由树（≤ 15 个指引项）。

**规范文档（Rules，AI 阅读）**  
- `guide/routing-rules.md`（文档路由原则、渐进式拆分法）。  
- `guide/capability-rules.md`（能力注册/功能体注册、晋级标准、命名规范）。  
- `guide/ai-friendly.md`（workdocs、上下文恢复、触发/护栏协作）。  
- `guide/module-rules.md`（模块目录规范、依赖/关系、跨模块提交策略）。  
- `guide/init-rules.md`（项目/模块初始化“只注册+就绪文档”的终点定义与校验清单）。

**格式规范（Schemas & Examples，AI 阅读）**  
- `spec/front-matter.schema.yaml` / `spec/workdocs.schema.yaml` / `spec/registry.schema.yaml` / `spec/triggers.schema.yaml`。  
- `examples/`：按渐进式提供 scope-topic-when、模块示例架构、功能体说明样例。

**人类阅读文档（Human，AI 禁读）**  
- `HUMANS.md`（索引） / `CONTRIBUTING.md` / `GOVERNANCE.md` / `ONBOARDING.md`。  
- 统一在文首声明：**“本文件供人阅读，AI 请勿加载。”**

---

## 6. 跨模块开发的落地方案（建议）
- **拆分原则**：每个执行单元仅触达一个模块目录；跨模块 = Orchestrator 任务图 + 子任务（每模块一条）。  
- **关系表达**：在 `modules/registry.yaml` 维护 `requires/provides`；自动生成 `module-relations.mmd`。  
- **编排执行**：由 Orchestrator 读取父任务 DAG，顺序/并行调度子任务；结果汇总在父任务 workdoc。  
- **守则**：CI 禁止单 PR 同时变更多个模块目录；触发器拦截“跨模块直接调用”。

---

## 7. 初始化（项目 / 模块）
**共同原则**：脚手架 → 交互问答收集信息 → 生成**只注册+就绪文档** → 验证清单通过 → 结束。

### 模块初始化
- **输入**：模块类型/实例名、职责、依赖、对外功能体、所需基础能力。  
- **输出**：目录骨架、`AGENTS.md`、模块 `ROUTING.md`、功能体说明、注册项（module/agent/capability）、占位用例、触发器占位。  
- **校验**：注册一致性、路由可达、命名规范、占位用例可运行。  
- **存放**：规范在 `guide/init-rules.md`；脚手架在 `scripts/scaffold-module/`；临时过程文件在 `init/`，完成后删除。

### 项目初始化
- **输入**：业务域、模块蓝图、全局规范差异、CI/环境信息。  
- **输出**：根级别策略与路由、初始模块清单、注册/触发器基础集、HUMANS 文档集。  
- **校验**：四大思路覆盖度、入口最小闭环、注册/触发/路由一致性。  
- **临时目录**：`init/` 存放使用说明、快速引导、问卷、生成的中间文件；初始化完成后整体删除。

---

## 8. 验收标准（草案）
- **路由可达率**：入口至任一叶子文档的可达性 ≥ 99%。  
- **一致性**：注册表 ↔ 文档 ↔ 目录结构的一致性校验全绿。  
- **功能体成熟度**：进入路由的功能体≥候选级，覆盖最小用例；依赖能力在注册表中可追溯。  
- **触发质量**：干跑通过率 100%；冲突检测 0；P0 触发平均阻断 < 2 分钟。  
- **AI 友好度**：从 `workdocs` 恢复到“可继续编码”的平均时间 < 2 分钟；错误复发率按季度下降。  
- **跨模块健康**：跨模块改动均为“父+子 PR”形态；无直接跨目录写入。

---

## 9. 下一步（阶段2收尾 → 阶段3）
1) 对 **D1–D9** 逐项拍板（若无异议，按“建议”落地为默认）。  
2) 输出三份“**规范模板**”初稿：`guide/capability-rules.md`、`guide/module-rules.md`、`guide/init-rules.md`。  
3) 输出两份“**格式规范**”初稿：`spec/front-matter.schema.yaml`、`spec/triggers.schema.yaml`。  
4) 拉起“**初始化脚手架**”骨架：`scripts/scaffold-module/` 与 `scripts/scaffold-project/`（只收集→只注册）。  
5) 准备“**阶段3执行计划**”大纲：任务分解、里程碑、度量与回滚。

---

## 10. 风险与对策
- **过度建模**：先以最小集合起步（入口/注册/路由/触发/护栏），其余按晋级规则渐进引入。  
- **触发泛滥**：命名空间+优先级+互斥组+干跑/冲突检测，纳入 CI。  
- **文档漂移**：将一致性校验列为 PR 必过项；变更即校验。  
- **跨模块耦合**：CI/触发器硬性隔离；只允许 Orchestrator 串联。

---

> 以上建议均可在阶段3中转化为“可执行清单+脚本/校验+CI Gate”。